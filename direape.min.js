!function(){function initPid(){if(!da.pid){if(self.crypto||!isNodeJs())return da.pid||Promise.resolve().then((()=>self.crypto.subtle||(self.crypto.subtle=self.crypto.webkitSubtle))).then((()=>self.crypto.subtle.generateKey({name:"ECDSA",namedCurve:"P-521"},!0,["sign","verify"]))).then((key=>self.crypto.subtle.exportKey("spki",key.publicKey))).then((spki=>publicKey=spki)).then((buf=>self.crypto.subtle.digest("SHA-256",buf))).then((buf=>btoa(da.buf2ascii(buf)))).then((base64=>da.pid=da.nid=base64))["catch"]((e=>{throw document.body.innerHTML=`
              This app requires a browser that supports web cryptography.<br>
              This has been tested to work recent Chrome and Firefox.`,e}));publicKey=Math.random().toString(),da.pid=require("crypto").createHash("sha256").update(publicKey).digest("base64")}}function makeCallbackHandler(resolve,reject){function handler(result,error){clearTimeout(timeout),da.handle(name,null),error?reject(error):resolve(result)}var name="callback"+Math.random().toString().slice(2),timeout=setTimeout((()=>handler(null,"call timeout")),callTimeout);return da.handle(name,handler,{"public":!0}),name}function send(msg){messageQueue.push(msg),schedulePostman()}function schedulePostman(){postmanScheduled||(da.nextTick(postman),postmanScheduled=!0)}function postman(){postmanScheduled=!1;var messages=messageQueue;messageQueue=[];for(var i=0;i<messages.length;++i)processMessage(messages[i])}function processMessage(msg){msg.dstPid===da.pid?processLocalMessage(msg):relay(msg)}function processLocalMessage(msg){var handler=handlers.get(msg.dstName)||{};if(msg.external&&!handler["public"])return sendReply(msg,[null,"no such public function"]);var fn=handler.fn;return fn?void Promise.resolve(fn.apply(msg,msg.data)).then((result=>sendReply(msg,[result])))["catch"]((e=>sendReply(msg,[null,e]))):(console.log("no such function:",msg.dstName),sendReply(msg,[null,"no such function"]))}function sendReply(msg,data){void 0!==msg.srcPid&&void 0!==msg.srcName&&send({dstPid:msg.srcPid,dstName:msg.srcName,data:data})}function isWorker(){return!!self.postMessage&&1===self.postMessage.length}function relay(msg){if(isWorker())self.postMessage(msg);else if(isBrowser()){var child=children.get(msg.dstPid);child?child.postMessage(msg):relayNetwork(msg)}else relayNetwork(msg)}function initWorker(){isWorker()&&(self.onmessage=(o=>send(o.data)),self.postMessage({}))}function loadWorkerSource(){if(!workerSourcePromise){var source,reunRequest=da.GET("https://unpkg.com/reun@0.2");workerSourcePromise=da.GET(isDev()?"./direape.js":"https://unpkg.com/direape@0.2").then((src=>source=src)).then((()=>reunRequest)).then((reun=>source+reun))}return workerSourcePromise}function isDev(){return isNodeJs()?process.env.DIREAPE_DEV:da.global.DIREAPE_DEV}function closeWebSocket(){websocket&&(websocket.onerror=(()=>null),websocket.close())}function relayNetwork(msg){if(isNodeJs()){var dst=wsClients.get(msg.dstPid.slice(0,44));console.log("relay",msg,wsClients.keys(),dst),dst&&(console.log("relay send",msg),dst.send(JSON.stringify(msg)))}else websocket&&websocket.send(JSON.stringify(msg))}function initHandlers(){isNodeJs()&&da.handle("da:list-clients",(()=>Array.from(wsClients.keys())),{"public":!0}),da.handle("da:GET",da.GET),da.handle("da:status",(()=>({pid:da.pid,time:Date.now()})),{"public":!0}),isBrowser()||da.handle("da:children",da.children)}function isNodeJs(){return!!((self.process||{}).versions||{}).node}function isBrowser(){return!!self.window}function jsonReplacer(o){var jsonifyWhitelist=["stack","name","message","id","class","value"];if("object"!=typeof o&&"function"!=typeof o||null===o||Array.isArray(o)||o.constructor===Object)return o;var result,k,i;if("number"==typeof o.length)for(result=[],i=0;i<o.length;++i)result[i]=o[i];for(result=Object.assign({},o),o.constructor&&o.constructor.name&&void 0===result.$_class&&(result.$_class=o.constructor.name),o instanceof ArrayBuffer&&(result.base64=self.btoa(String.fromCharCode.apply(null,new Uint8Array(o)))),i=0;i<jsonifyWhitelist.length;++i)k=jsonifyWhitelist[i],void 0!==o[k]&&(result[k]=o[k]);return result}function nextTick(f){setTimeout(f,0)}function testSuite(str){currentTestSuite=str}function test(name,f){currentTestSuite&&(name=currentTestSuite+":"+name),f.testName=name,tests||(tests=[]),tests.push(f)}function runTest(t){var err,p;try{p=Promise.resolve(t())}catch(e){p=Promise.reject(e)}var timeout=new Promise(((_,reject)=>setTimeout((()=>reject(new Error("Timeout"))),testTimeout)));return p=Promise.race([p,timeout]),p=p["catch"]((e=>err=e)),p=p.then((()=>{if(err){if(console.log('Test error in "'+(t.testName||"")+": "+err.message),err.assert)try{console.log(JSON.stringify(err.assert))}catch(e){console.log(err.assert)}throw err.stack&&console.log(err.stack),err}}))}function throwAssert(o){var err=new Error("AssertError");throw err.assert=o,err}function setupModule(){testSuite("direape"),"undefined"==typeof self&&(global.self=global),self.URL||(self.URL=self.webkitURL),isBrowser()&&"http:"===self.location.protocol&&"localhost"!==self.location.hostname&&(self.location.href=self.location.href.replace(/http/,"https")),da=self.direape||{},"undefined"==typeof module?self.direape=da:module.exports=da}var da;setupModule(),da.test=test;var handlers;da.handle=((name,fn,opt)=>{fn||handlers["delete"](name),handlers.set(name,Object.assign(opt||{},{fn:fn}))}),da.emit=function(pid,name){send({dstPid:pid,dstName:name,data:da.slice(arguments,2)})},da.call=function(pid,name){return new Promise(((resolve,reject)=>send({dstPid:pid,dstName:name,srcPid:da.pid,srcName:makeCallbackHandler(resolve,reject),data:da.slice(arguments,2)})))};var publicKey,messageQueue=[],postmanScheduled=!1,callTimeout=1e4;if(handlers=new Map,da.isWorker=isWorker,isBrowser()){var children;da.spawn=(()=>new Promise(((resolve,reject)=>{loadWorkerSource().then((workerSource=>{var childPid=da.pid+Math.random().toString(36).slice(2,12);workerSource=`
          self.direape = {
            pid: '${childPid}',
            nid: '${da.pid}'
          };
        `+workerSource;var workerSourceUrl=URL.createObjectURL(new Blob([workerSource],{type:"application/javascript"})),child=new self.Worker(workerSourceUrl);console.log(child),children.set(childPid,child),child.onmessage=(o=>{child.onmessage=(o=>send(o.data)),URL.revokeObjectURL(workerSourceUrl),resolve(childPid)})}))}))),da.children=(()=>children.keys()),da.kill=(pid=>{children.get(pid).terminate(),children["delete"](pid)}),children=new Map}var workerSourcePromise;if(isBrowser(),isBrowser()){var websocket;da.online=function(url){return 0===arguments.length?websocket&&1===websocket.readyState:(closeWebSocket(),url?("string"!=typeof url&&(url="wss://direape.solsort.com"),new Promise(((resolve,reject)=>{websocket=new WebSocket(url),websocket.onopen=(()=>{websocket.send(JSON.stringify({direapeConnect:da.buf2ascii(publicKey)})),resolve(!0)}),websocket.onerror=(e=>{da.emit(da.pid,"da:socket-error",e),reject(e)}),websocket.onmessage=(o=>{var msg=o.data;msg=JSON.parse(msg),msg.external=msg.external||!0,send(msg)})}))):void 0)}}if(isNodeJs())var wsClients=new Map;isNodeJs()&&(da.startServer=(()=>{var app=require("express")();app.use(require("express")["static"]("."));var server=require("http").createServer(app),wss=new(require("ws").Server)({perMessageDeflate:!1,server:server});wss.on("connection",(ws=>{var nid;ws.on("message",(msg=>{msg=JSON.parse(msg),msg.direapeConnect?(nid&&wsClients["delete"](nid),nid=require("crypto").createHash("sha256").update(msg.direapeConnect).digest("base64"),wsClients.set(nid,ws)):(msg.external=nid,"server"===msg.dstPid&&(msg.dstPid=da.pid),send(msg))})),ws.on("close",(()=>{nid&&wsClients["delete"](nid)}))})),server.listen(8888,(()=>console.log("started server on port 8888")))})),da.global=self;var waiting=[];da.ready=(fn=>{waiting?waiting.push(fn):fn()}),da.isNodeJs=isNodeJs,da.isBrowser=isBrowser,da.log=function(msg,o){return console.log.apply(console,arguments),o},da.trace=da.log,self.XMLHttpRequest?da.GET=(url=>new Promise(((resolve,reject)=>{var xhr=new XMLHttpRequest;xhr.open("GET",url),xhr.onreadystatechange=(()=>4===xhr.readyState&&(200===xhr.status&&"string"==typeof xhr.responseText?resolve(xhr.responseText):reject(xhr))),xhr.send()}))):da.GET=(url=>new Promise(((resolve,reject)=>{return"."!==url[0]?require("request")(url,((err,res,body)=>err||200!==res.statusCode?reject(err):resolve(body))):void resolve(require("fs").readFileSync(url))}))),da.jsonify=(o=>JSON.parse(JSON.stringify([o],((k,v)=>jsonReplacer(v))))[0]),da.nextTick=nextTick,da.slice=((a,start,end)=>{return Array.prototype.slice.call(a,start,end)}),da.buf2ascii=(buf=>Array.from(new Uint8Array(buf)).map((i=>String.fromCharCode(i))).join("")),da.equals=((a,b)=>{if(a===b)return!0;if("object"!=typeof a||"object"!=typeof b||null===a||null===b)return!1;if(Array.isArray(a)){if(!Array.isArray(b))return!1;if(a.length!==b.length)return!1;for(var i=0;i<a.length;++i)if(!da.equals(a[i],b[i]))return!1;return!0}if(a.constructor===Object){if(b.constructor!==Object)return!1;if(!da.equals(Object.keys(a).sort(),Object.keys(b).sort()))return!1;for(var key in a)if(!da.equals(a[key],b[key]))return!1;return!0}return"function"==typeof a.equals?a.equals(b):!1});var testTimeout=5e3;da.assert=(ok=>ok||throwAssert({type:"truthy",val:ok})),da.assertEquals=((val1,val2)=>da.equals(val1,val2)||throwAssert({type:"equals",vals:[val1,val2]}));var currentTestSuite;da.testSuite=testSuite;var tests;da.test=test;da.runTests=(modules=>{var ts=tests;return modules&&(Array.isArray(modules)||(modules=[modules]),ts=ts.filter((t=>modules.some((m=>t.testName.startsWith(m+":")))))),Promise.all(ts.map(runTest)).then((e=>{console.log("All tests ok:",ts.map((o=>JSON.stringify(o.testName))).join(", "))}))}),Promise.resolve(initPid()).then(initHandlers).then(initWorker).then((()=>{for(var i=0;i<waiting.length;++i)waiting[i]();waiting=!1})),testSuite(""),da.ready((()=>{self.DIREAPE_RUN_TESTS&&da.runTests(),isNodeJs()&&require.main===module&&-1!==process.argv.indexOf("test")&&da.runTests("direape").then((o=>{-1!==process.argv.indexOf("server")?da.startServer():process.exit(0)}))["catch"]((e=>process.exit(-1)))}))}();
